# 師大課程查詢與排課系統 (優化版)

這是一個基於 Python 與 PySide6 開發的桌面應用程式，專為師大課程查詢與排課設計。本版本經過效能優化，針對大量課程資料的搜尋、篩選與最佳選課運算進行了大幅度的加速。

## 主要功能

*   **極速搜尋**：支援開課序號、代碼、課名、教師、系所等多條件即時篩選。
*   **智慧排課**：視覺化課表，支援拖曳選取時段、排除衝堂、排除已選。
*   **最佳選課**：根據我的最愛、優先順序與鎖定課程，自動計算學分最大化且符合志願序的最佳組合。
*   **資料管理**：支援多使用者設定檔、歷史紀錄回溯、Excel 匯出、PDF 課表匯出。

## 本次優化與更新內容 (Changelog)

### 1. 效能優化 (Performance)
*   **搜尋加速**：
    *   實作 **簽名快取 (Signature Cache)**，避免重複運算。
    *   **向量化篩選**：將通識、滿額等條件改為預先計算的布林/位元遮罩。
    *   **稀疏矩陣優化**：針對文字搜尋（課名/教師）實作子集掃描策略。
    *   **搜尋記憶體優化**：在子集搜尋時僅切片所需欄位，避免複製 DataFrame。
    *   **結果列表快取優化**：避免重複建立欄位快取，並快取關鍵欄位索引以減少字串比對。
    *   **ID 查找優化**：使用 `searchsorted` (O(k log n)) 取代 `isin`。
*   **零複製 (Zero-Copy)**：搜尋結果改用 Row-index mapping，不再複製 DataFrame，降低記憶體壓力。
*   **最佳選課演算法**：
    *   改用 **平行 List** 與 **Parent Pointer** 回溯，減少物件建立。
    *   實作 **Mask 去重 (Pruning)**，提早排除劣解。
*   **UI 渲染**：
    *   課表繪製重用 `QTableWidgetItem` 與快取 Brush/Color。
    *   **重繪優化**：課表更新時檢查顏色狀態，避免不必要的 `setBackground` 呼叫。
    *   結果列表使用 Numpy Array 快取欄位資料。
    *   **時段解析快取**：預先解析時段字串，加速課表渲染時的時段收集。
    *   **拖曳選取優化**：向量化課表時間拖曳選取的遮罩計算。
    *   **渲染資源預計算**：預先建立課表背景 Brush，減少重繪時的物件建立。
    *   **工具函式快取**：`slot_to_mask` 加入 LRU Cache，加速 Excel 載入與遮罩計算。
*   **資料 I/O**：
    *   Excel 載入優化（Header 預讀）。
    *   **向量化資料解析**：在 Excel 載入階段，使用向量化操作取代 `apply`，加速開課序號與時間地點的解析。
    *   存檔使用 `write_only` 模式與 **原子寫入 (Atomic Save)**。

### 2. 新增功能 (New Features)
*   **PDF 匯出**：支援匯出 A4 直向課表，自動縮放填滿頁面。
*   **High DPI 支援**：優化高解析度螢幕顯示。
*   **關於視窗**：新增版本與開發者資訊說明。

### 3. 基礎建設 (Infrastructure)
*   **CI/CD**：新增 GitHub Actions 自動測試與打包流程。
*   **單元測試**：新增 `test_timetable_logic.py` 驗證核心邏輯。
*   **啟動優化**：延遲 Excel 載入，提升視窗顯示速度。

## 環境需求

*   Windows 10/11 (建議)
*   Python 3.8+

## 安裝與執行

### 1. 安裝依賴套件

請在專案根目錄執行：

```bash
pip install -r requirements.txt
```

### 2. 執行程式

```bash
python app_main.py
```

### 3. 執行單元測試

為確保核心邏輯正確，可執行以下指令跑測試：

```bash
python -m unittest test_timetable_logic.py
```

## 打包成執行檔 (EXE)

本專案已包含 PyInstaller 設定檔 (`main.spec`) 與自動化腳本 (`build.bat`)。

### 方法 A：使用批次檔 (推薦)

直接雙擊執行 `build.bat`，它會自動安裝依賴、執行測試並進行打包。

### 方法 B：手動打包

```bash
pyinstaller main.spec --clean --noconfirm
```

打包完成後，執行檔將位於 `dist\師大課程查詢系統\師大課程查詢系統.exe`。

## 使用說明

1.  啟動程式後，請先透過「檔案 -> 開啟課程 Excel」載入學校課程資料表。
2.  建立或選擇使用者後，即可開始使用搜尋與排課功能。